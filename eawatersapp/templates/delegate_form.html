{% load static %}

<link rel="stylesheet" href="{% static 'css/delegate_form.css' %}">
<div class="mdc-card delegateForm">
    <h2 style="text-align: center;">Register</h2>
        {% csrf_token %}
        <input type="hidden" id="currentStep" value="1">
        <!-- Step 1 -->
        <div class="formStep" id="step1">
            <select name="title" class="eawaters_select_input" id="title">
                <option value="Prof.">Prof.</option>
                <option value="Dr.">Dr.</option>
                <option value="Eng.">Eng.</option>
                <option selected value="Mr.">Mr.</option>
                <option value="Ms.">Ms.</option>
                <option value="Mrs.">Mrs.</option>
            </select>
            <input class="eawaters_text_input" placeholder="First Name" type="text" id="first_name"/>
            <input class="eawaters_text_input" placeholder="Last Name" type="text" id="last_name"/>
            <br>
            <hr>
            <div style="display: flex;">
                <button class="primary_button" onclick="nextStep()">Next</button>
            </div>
        </div>


        <!-- Step 2 -->
        <div class="formStep" id="step2">
            {% include 'countries_select.html' %}
            <input class="eawaters_text_input" placeholder="+254712345678" type="tel" id="phone"/>
            <input class="eawaters_text_input" placeholder="john@example.com" type="email" id="email"/>
            <br>
            <hr>
            <div style="display: flex;">
                <button class="secondary_button" onclick="prevStep()">Back</button>
                <button class="primary_button" onclick="nextStep()">Next</button>
            </div>


        </div>

        <!-- Step 3 -->
        <div class="formStep" id="step3">
            <input class="eawaters_text_input" placeholder="Organization" type="text" id="organization"/>
            <input class="eawaters_text_input" placeholder="Job Title" type="text" id="job_title"/>
            <select name="association" class="eawaters_select_input" id="association">
                <option value="KWIA">KWIA</option>
                <option value="WASPA">WASPA</option>
                <option value="GSK">GSK</option>
                <option selected>Association</option>
            </select>
            <br>
            <hr>
            <div style="display: flex;">
                <button class="secondary_button" onclick="prevStep()">Back</button>
                <button class="primary_button" onclick="nextStep()">Next</button>
            </div>

        </div>

        <!-- Step 4 -->
        <div class="formStep" id="step4">
            <div class="" id="">
                <div class="radio_select">
                  <input selected type="radio" id="kenyan-delegate" name="delegate_type" class="delegate_type" value="kenyan-delegate" >
                  <label for="kenyan-delegate">Kenyan Delegate</label> <br>
                  <small class="text-secondary">KES. 570</small>
                </div>
                <!--<div class="radio_select">
                  <input type="radio" id="eac-delegate" class="delegate_type" name="delegate_type" value="eac-delegate" >
                  <label for="eac-delegate">EAC Delegate(Excl. Kenya)</label> <br>
                  <small class="text-secondary">FREE</small>
                </div> -->
                <div class="radio_select">
                  <input type="radio" class="delegate_type" id="intl-delegate" name="delegate_type" value="intl-delegate" >
                  <label for="intl-delegate">International Delegate</label> <br>
                  <small class="text-secondary">USD. 95</small>
                </div>
            </div>
            <div class="alert alert-success" style="display: none !important;" id="payment_alert_type_0" role="alert">
                Please Wait...
            </div>
            <div class="alert alert-danger" style="display: none !important;" id="payment_alert_type_1" role="alert">
                <div id="payment_alert_type_1_message">

                </div>
            </div>
            <div class="alert alert-success" style="display: none !important;" id="payment_alert_type_2" role="alert">
                <div id="payment_alert_type_2_message">

                </div>
            </div>
            <div id="packageDetails">
              <div class="mdc-card packageDetails">
                  <div class="packageTotal">
                      <div><strong>Delegate Fee</strong></div>
                      <div id="package_cost"></div>
                  </div>
                  <div class="paymentMethod">
                      <div><strong>Paybill Number</strong></div>
                      <div>749320</div>
                      <div><strong>Account Number</strong></div>
                      <div>Delegate2020</div>
                  </div>
              </div>
              <input class="eawaters_text_input" placeholder="MPESA Code" type="text" id="mpesa_code"/>
            </div>


            <div style="display: flex;">
                <button id="final_back_button" class="secondary_button" onclick="prevStep()">Back</button>
                <button id="finish_button" class="primary_button" onclick="finish()">Finish</button>
            </div>
        </div>
</div>

<script>
  var delegate_type="none";
  $("#finish_button").hide()

  $("#mpesa_code").change((e)=>{
    var mpesa_code_updated=e.target.value;
    if (mpesa_code_updated.length<10) {
        $("#finish_button").hide()
    }else{
        $("#finish_button").show()
    }
  })

  $("#packageDetails").hide()

  $('.delegate_type').change((e)=> {
    delegate_type=e.target.value
    if (delegate_type==="kenyan-delegate") {
       var my_mpesa_code_updated=$("#mpesa_code").val();
       if (my_mpesa_code_updated.length<10) {
        $("#finish_button").hide()
       }else{
        $("#finish_button").show()
       }
      $("#packageDetails").show()
    }else{
      $("#finish_button").show()
      $("#packageDetails").hide()
    }
  })

    axios({
        method:"GET",
        url:"https://www.eawaters.com/en/package?name=delegate-kes",
    }).then(response=>{
        console.log(response)
        if (response.status===200 && response.data.package ) {
            $("#package_cost").html("KES."+response.data.package.amount)
        }
    })

    function nextStep() {
        var current=parseInt($('#currentStep').val())
        var next=current+1
        $("#step"+current).css("display","none")
        $("#step"+next).css("display","flex")
        $('#currentStep').val(next)
    }

    function prevStep() {
        var current=parseInt($('#currentStep').val())
        var next=current-1
        $("#step"+current).css("display","none")
        $("#step"+next).css("display","flex")
        $('#currentStep').val(next)
    }

    async function checkMPESAPayment() {
      if (delegate_type!="kenyan-delegate") {
        console.log(delegate_type)
        return true
      }

        var mpesa_code=$("#mpesa_code").val()
        console.log(mpesa_code)
        let response=await axios({
            url:"https://tengenetsar.kipya-africa.com/api/shop/payment/payment-method-one/check",
            method:"POST",
            data:{
                code:mpesa_code
            },
        })
        console.log(response)
        if (response.status===200 && !response.data.NF) {
            $("#payment_alert_type_2_message").html("Confirmed Payment of KES. "+response.data.amount+" transaction code "+response.data.code+" for account number "+response.data.account_no+" by "+response.data.payment_by)
            $("#payment_alert_type_1").hide()
            $("#payment_alert_type_2").show()
            return true
        }else{
            $("#payment_alert_type_1_message").html(response.data.message)
            $("#payment_alert_type_0").hide()
            // $("#final_back_button").attr("disabled",false)
            // $("#finish_button").attr("disabled",false)
            $("#payment_alert_type_1").show()
            return false
        }

    }

    async function registerDelegate() {
        title = $("#title").val()
        first_name = $("#first_name").val()
        last_name = $("#last_name").val()
        country = $("#country").val()
        phone = $("#phone").val()
        email = $("#email").val()
        organization = $("#organization").val()
        job_title = $("#job_title").val()
        association = $("#association").val()
        mpesa_code = $("#mpesa_code").val()


        response=await axios({
            method:"POST",
            url:"https://www.eawaters.com/en/delegates",
            headers:{ "X-CSRFToken": $("input[name='csrfmiddlewaretoken']").val() },
            data:{
                title:title,
                first_name:first_name,
                last_name:last_name,
                email:email,
                phone:phone,
                country:country,
                organization:organization,
                job_title:job_title,
                association:association,
                mpesa_code:mpesa_code,
                delegate_type:delegate_type
            }
        })

        if (response.data.message==="Registration Success") {
          $("#payment_alert_type_0").html("Registration Success")
        }else if (response.data.message==="success") {
            alert(response.data.message)
        }else{
            // window.location.replace("/experience")
        }

    }


    function finish(){
        $("#payment_alert_type_0").show()
        // $("#final_back_button").attr("disabled",true)
        // $("#finish_button").attr("disabled",true)

        if(checkMPESAPayment()){
            console.log("checkMPESAPayment Passed")
            registerDelegate()
        }
    }


</script>
